#!/usr/bin/env node

'use strict';

const os = require('os');
const path = require('path');
const fs = require('bfile');
const common = require('../lib/common');
const cfg = require('../lib/config');
const {writeJSON, readJSON, exec} = require('../lib/util');
const wallet = require('../lib/wallet');

function help() {
  const help = `./bin/check-reveals WALLET_ID [CONTINUE] [OPTIONS]
  OPTIONS:
    --all do from 0 to 4.

  STEPS:


  Diff STEPS:
    all: Do steps from 1 to 4. (exc 0)
    status: get summary of classified data.
  `;

  console.error(help);
  process.exit(2);
}

(async () => {
  const config = cfg.parse();

  const id = config.str(0);

  if (!id)
    help();

  const client = wallet.client();
  const dataRoot = config.str('data-dir', os.tmpdir());
  const dataDir = path.join(dataRoot, `check-reveals-${id}`);
  const fileOwnNames = common.namesDumpFile(dataRoot, id);
  const fileFiltered = path.join(dataDir, '1-filter-reveals.json');
  const fileByHoursClosed = path.join(dataDir, '2-sorted-by-reveal-end.json');
  const fileRevealed = path.join(dataDir, '3-revealed.json');
  const fileNeedsReveals = path.join(dataDir, '3-needs-reveals.json');

  await fs.mkdirp(dataDir);

  const step = config.str(1, 'all');

  let fallthrough = config.bool([3, 'all'], false);

  switch (step) {
    case '0':
    case 'dump': {
      console.log('Getting wallet names...');

      const out = await exec([path.join(common.BIN, 'dump'), `names ${id}`], {
        env: cfg.configToENV(config)
      });

      console.log(out);

      if (!fallthrough)
        break;
    }

    case 'all':
      fallthrough = true;

    case '1':
    case 'filter': {
      const data = await readJSON(fileOwnNames, true);
      console.log('Filter names in reveal');
      const filtered = data.filter(d => d.state === 'REVEAL');
      await writeJSON(fileFiltered, filtered, true);

      if (!fallthrough)
        break;
    }

    case '2':
    case 'sort': {
      const data = await readJSON(fileFiltered, true);
      console.log('Sorting by height...');
      data.sort((a, b) => {
        return a.stats.hoursUntilClosed - b.stats.hoursUntilClosed;
      });

      await writeJSON(fileByHoursClosed, data, true);

      if (!fallthrough)
        break;
    }

    case '3':
    case 'check-reveals': {
      const data = await readJSON(fileByHoursClosed, true);

      console.log('Gathering auction information...');

      const revealed = [];
      const needsReveals = [];

      for (const info of data) {
        const name = info.name;
        const auction = await wallet.getAuctionInfo(client, id, name);
        const bids = new Map();

        if (auction.state !== 'REVEAL')
          console.log('names dump has expired:', auction.name, auction.state);

        for (const bid of auction.bids) {
          if (bid.own === false)
            continue;

          bids.set(toKey(bid), false);
        }

        for (const reveal of auction.bids) {
          if (reveal.own === false)
            continue;

          const key = toKey(reveal);

          if (!bids.has(key))
            throw new Error('Data inconsistency.');

          bids.set(key, true);
        }

        let consistent = true;
        for (const r of bids.values()) {
          if (!r) {
            consistent = false;
            break;
          }
        }

        if (consistent)
          revealed.push(info);
        else
          needsReveals.push(info);
      }

      await writeJSON(fileNeedsReveals, needsReveals, true);
      await writeJSON(fileRevealed, revealed, true);

      if (!fallthrough)
        break;
    }

    case 'status': {
      const revealed = await readJSON(fileNeedsReveals, true);
      const needsReveals = await readJSON(fileNeedsReveals, true);

      console.log(`
        Total: ${revealed.length + needsReveals.length}
        Revealed: ${revealed.length}
        Needs Reveal: ${needsReveals.length}
      `);
    }
  }
})().catch((e) => {
  console.error(e);
  process.exit(1);
});

function toKey(info) {
  return info.prevout.hash + info.prevout.index;
}
